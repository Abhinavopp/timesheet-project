<div class="projects-container">
  <div class="projects-header">
    <h1 class="page-title">Projects</h1>

    <div class="view-controls">
      <!-- <button class="view-btn" [class.active]="viewMode === 'grid'" (click)="setViewMode('grid')">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <rect x="2" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5" />
          <rect x="9" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5" />
          <rect x="2" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5" />
          <rect x="9" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5" />
        </svg>
        Grid
      </button>
      <button class="view-btn" [class.active]="viewMode === 'list'" (click)="setViewMode('list')">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M2 4H14M2 8H14M2 12H14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg>
        List
      </button>
      <button class="view-btn">Templates</button> -->
    </div>

    <div class="header-actions">
      <div class="search-box flex items-center border p-2 rounded">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <circle cx="7" cy="7" r="5" stroke="currentColor" stroke-width="1.5" />
          <path d="M11 11L14 14" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
        </svg>
        <input 
        type="text" 
        placeholder="Search Project..." 
        class="ml-2 flex-1 outline-none" 
        [(ngModel)]="searchTerm" 
        (input)="onSearch()" />
      </div>
<!--       
      <select class="status-select">
        <option value="Active">Active</option>
        <option value="Archived">Archived</option>
        <option value="All">All</option>
      </select> -->
      <button type="button" class="btn btn-outline-primary" (click)="openclientPopup()">
      
        Add Client
      </button>
      <button type="button" class="btn btn-outline-primary" (click)="openmodalPopup()">
      
        Add Bucket
      </button>
      <button type="button" class="btn btn-primary" (click)="openModal()">
      
        Add Projects
      </button>
    </div>
  </div>

  <div class="projects-content position-relative">
    <!-- <div class="loader-container">
      <div class="loader"></div> 
      </div> -->
    <h2 class="section-title">Active Projects</h2>

    <!-- Grid View -->
    <div class="projects-grid" *ngIf="viewMode === 'grid'">
      <div class="row">
        <div class="col-lg-6 mb-4" *ngFor="let p of filteredProjects">
          <div class="project-card">
          <div class="project-edit" (click)="openEdit(p)">
            <svg viewBox="0 0 24 24" width="18" height="18" stroke="#ffffff" stroke-width="2" fill="none"
              stroke-linecap="round" stroke-linejoin="round" class="css-i6dzq1">
              <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
            </svg>
          </div>
            <!-- Project Name -->
            <h3 class="project-name">{{ p.name }}</h3>

            <!-- Creator Info -->
            <p class="project-company">
              Created by {{ p.createdBy }} on
              {{ p.createdDate | date: 'MMM d, y' }}
            </p>

            <div class="project-content">

              <!-- OWNERS + INCHARGE SECTION -->
              <!-- OWNERS + INCHARGE SECTION -->
              <!-- OWNERS + INCHARGE SECTION -->
              <div class="owners-row">

                <!-- PROJECT OWNERS -->
                <div class="owner-item">
                  <h3 class="proj-heading">Project Owner</h3>
                  <div class="project-footer">
                    <div class="project-avatars">

                      <ng-container *ngFor="let o of p.users?.owner?.slice(0, 4)">
                        <div class="avatar">
                          <img [src]="getUserImage(o)" class="avatar-img" (error)="onImageError($event)" />
                        </div>
                      </ng-container>

                      <div class="avatar more-badge" *ngIf="p.users?.owner?.length > 4">
                        +{{ p.users.owner.length - 4 }} more
                      </div>

                    </div>
                  </div>
                </div>

                <!-- PROJECT INCHARGE -->
                <div class="owner-item">
                  <h3 class="proj-heading">Project Incharge</h3>
                  <div class="project-footer">
                    <div class="project-avatars">

                      <ng-container *ngFor="let i of p.users?.incharge?.slice(0, 4)">
                        <div class="avatar">
                          <img [src]="getUserImage(i)" class="avatar-img" (error)="onImageError($event)" />
                        </div>
                      </ng-container>

                      <div class="avatar more-badge" *ngIf="p.users?.incharge?.length > 4">
                        +{{ p.users.incharge.length - 4 }} more
                      </div>

                    </div>
                  </div>
                </div>

              </div>


              <!-- CLIENTS SECTION -->
              <div class="content-section">
                <h3 class="proj-heading">Clients</h3>

                <!-- Show "No Client" -->
                <p *ngIf="!p?.clients || p.clients.length === 0" class="client-badge">No Client</p>

                <!-- Show multiple clients -->
                <ng-container *ngIf="p?.clients?.length > 0">
                  <span class="client-badge me-2" *ngFor="let c of p.clients">
                    {{ c.name }}
                  </span>
                </ng-container>
              </div>

              <!-- STATS -->
              <div class="stat-grid">
                <div class="stat-item">
                  <div class="stat-label">Participants</div>
                  <div class="stat-value">{{ p.users.assigned.length }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">Requested</div>
                  <div class="stat-value">{{ p.users.requested.length }}</div>
                </div>
                <div class="stat-item">
                  <div class="stat-label">Worked Hours</div>
                  <div class="stat-value">{{ p.workedHours | number:'1.2-2' }}</div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- List View -->
    <div class="projects-list" *ngIf="viewMode === 'list'">
      <div class="project-list-item">
        <div class="list-item-left">
          <button class="star-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <path
                d="M10 2L12.163 7.326L18 8.11L14 12.028L14.945 18L10 15.326L5.055 18L6 12.028L2 8.11L7.837 7.326L10 2Z"
                stroke="currentColor" stroke-width="1.5" stroke-linejoin="round" />
            </svg>
          </button>
          <div class="list-item-content">
            <div class="list-item-header">
              <h3 class="list-project-name">project.name</h3>
              <span class="list-project-company">Sci-Tech</span>
              <span class="status-badge">active</span>
            </div>
            <p class="list-project-description">A design is the concept or proposal for an object, process, or system.
              The word design refers to something that is or has been intentionally</p>
          </div>
        </div>
        <div class="list-item-right">
          <div class="project-avatars">
            <div class="avatar" style="background: #f59e0b;">S</div>
            <div class="avatar" style="background: #f97316;">J</div>
            <div class="avatar" style="background: #10b981;">K</div>
          </div>
          <div class="progress-info">
            <span class="progress-label">Progress</span>
            <span class="progress-value">0%</span>
          </div>
          <button class="menu-btn">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
              <circle cx="10" cy="4" r="1" fill="currentColor" />
              <circle cx="10" cy="10" r="1" fill="currentColor" />
              <circle cx="10" cy="16" r="1" fill="currentColor" />
            </svg>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>




<ng-template #projectFormModal>
  <div class="modal-header">
    <h4 class="modal-title">{{ editingProject ? 'Update Project' : 'Add Project' }}</h4>
     <button type="button" class="btn-close"
      (click)="closemodalPopup2()"></button>
  </div>
  <div class="modal-content">
    <div class="step-content">

      <form [formGroup]="projectForm" (ngSubmit)="onSubmit()" class="space-y-4">
        <!-- Project Name -->
        <div class="mb-3">
          <label class="block mb-1 font-medium">Project Name</label>
          <input type="text" formControlName="name" placeholder="Enter Project Name"
            class="w-full border rounded p-2 form-control" />
        </div>

        <!-- Client -->
        <div class="mb-3">
          <label class="block mb-1 font-medium">Client Name</label>
          <ng-select [items]="clients" bindLabel="name" bindValue="_id" formControlName="client" [multiple]="true"
            placeholder="Select Client Name" [searchable]="true" class="w-full">
          </ng-select>
        </div>

        <!-- Participants -->
        <div class="mb-3">
          <label class="block mb-1 font-medium">Participants</label>
          <ng-select [items]="users" bindLabel="firstName" bindValue="_id" formControlName="participants"
            [multiple]="true" placeholder="Select Participants" [searchable]="true" class="w-full">
          </ng-select>
        </div>

        <!-- Project Incharge -->
        <div class="mb-3">
          <label class="block mb-1 font-medium">Project Incharge</label>
          <ng-select [items]="filteredUsers" bindLabel="firstName" bindValue="_id" formControlName="incharge"
            [multiple]="true" placeholder="Select Project Incharge" [searchable]="true"
            [disabled]="filteredUsers.length === 0" class="w-full">
          </ng-select>
        </div>

        <!-- Business Owners -->
        <div class="mb-3">
          <label class="block mb-1 font-medium">Business Owners</label>
          <ng-select [items]="filteredUsers" bindLabel="firstName" bindValue="_id" formControlName="owners"
            [multiple]="true" placeholder="Select Business Owners" [searchable]="true"
            [disabled]="filteredUsers.length === 0" class="w-full">
          </ng-select>
        </div>

        <div class="mb-3">
          <div class="flex items-center space-x-2">
            <input type="checkbox" formControlName="timeEntry" checked />
            <label class="text-sm ms-2">Time entry required?</label>
          </div>
        </div>
        <div class="d-flex justify-content-end">

          <button class="cancel-btn" (click)="closemodalPopup2()">Cancel</button>

          <button type="submit" class="btn btn-primary w-full ms-3">
            {{ editingProject ? 'Update Project' : 'Create Project' }}
          </button>
        </div>

      </form>

    </div>
  </div>

</ng-template>

<ng-template #projectModal>
  <form [formGroup]="bucketForm">
    <div class="modal-header">
      <h4 class="modal-title">Add Buckets</h4>
      <button type="button" class="btn-close" (click)="closemodalPopup()"></button>
    </div>

    <div class="modal-body">

      <!-- Select Project -->
      <div class="mb-3">
        <label class="block mb-1 font-medium">Project</label>

        <ng-select
          [items]="projects"
          bindLabel="name"
          bindValue="_id"
          placeholder="Select Project"
          formControlName="projectId"
          (change)="onProjectSelect()"
          class="w-full">
        </ng-select>
      </div>

      <!-- Select Buckets -->
      <div class="mb-3">
        <label class="block mb-1 font-medium">Bucket Name</label>

        <ng-select
          [items]="buckets"
          bindLabel="name"
          bindValue="_id"
          [multiple]="true"
          placeholder="Select Bucket"
          formControlName="buckets"
          [disabled]="!bucketForm.get('projectId')?.value"
          class="w-full">
        </ng-select>
      </div>

    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closemodalPopup()">Close</button>
      <button class="btn btn-primary" (click)="submitBucket()">Submit</button>
    </div>
  </form>
</ng-template>


<ng-template #clientModal>
  <form [formGroup]="clientForm">
    <div class="modal-header">
      <h4 class="modal-title">Add Client</h4>
      <button type="button" class="btn-close" (click)="closemodalPopup3()"></button>
    </div>

    <div class="modal-body">
      <div class="mb-3">
        <label class="block mb-1 font-medium">Client Name</label>
        <input
          class="form-control"
          formControlName="name"
          placeholder="Enter client name..."
        />
      </div>
    </div>

    <div class="modal-footer">
      <button class="btn btn-secondary" (click)="closemodalPopup3()">Close</button>
      <button class="btn btn-primary" (click)="submitClient()">Submit</button>
    </div>
  </form>
</ng-template>
